# Ingress

`pod network`, `service network`를 통해서 쿠버네티스 클러스터 내부에서의 노드간 통신, 파드간 통신, 서비스 IP을 통한 통신이 가능하게 되었다. 남은 것은 외부에 있는 클라이언트의 요청을 받아야 하는 것이다.


## Route to Specific Node

이미 클러스터 내부에 있는 `service network`에서 사용하는 `Cluster IP`는 잘 작동하고 있기 때문에 외부에서도 이것을 사용하는 것이 좋아보인다. 하지만 Cluster IP는 클러스터 내부에 있는 노드의 인터페이스에서만 처리할 수 있다. 이 주소를 외부로 노출시키기 위해서 게이트웨이에 서비스 네트워크를 특정 노드로 포워딩시키는 시나리오가 있다.
<br>
그림은 다음과 같다. 
 
<img src="https://user-images.githubusercontent.com/44857109/103460903-809cf780-4d5d-11eb-9823-fd84b346b725.png" width="80%" height="80%">

`10.3.241.152:80`에 대한 외부요청은 라우팅 규칙을 통해 쿠버네티스 클러스터의 노드인 `10.100.0.3`으로 전달되기 때문에 해당 요청을 특정 파드로 전달할 수 있게 된다.
<br>

여기엔 몇가지 문제가 있다. 먼저 노드는 파드만큼은 아니지만 일시적으로 존재하는 구성요소이다. 클러스터를 스케일링하기 위해 노드를 추가시키거나 제거할 수 있기 때문이다. 또한 네트워크 계층(OSI 3계층)에서는 서비스들의 헬스 정보를 관리할 수 없다. 만약 노드가 아주 안정적이여서 죽지 않는다고 가정해도 외부의 모든 요청이 특정한 한 노드로 몰리기 때문에 효율적이지 않다.

## Using Load Balancer

외부의 요청에 대해서 클러스터가 단일 노드의 상태에만 의존하지 않도록 하는 방법은 이미 있다. 로드밸런서를 사용하는 것이다. 하지만 여기서 또 문제가 발생한다.
<br>

<img src="https://user-images.githubusercontent.com/44857109/103462051-f5742f80-4d65-11eb-8790-fad7530bac92.png" width="80%" height="80%">

서비스 네트워크(Cluster IP)는 클러스터 노드의 인터페이스만 처리할 수 있기 때문에 게이트웨이 외부에 있는 로드밸런서는 `10.3.240.0/20`을 이용해서 부하분산을 처리할 수 없다. 로드밸런서는 각 노드의 네트워크인 `10.100.0.0/24`를 이용해서 외부 요청을 특정 노드로 전달해야 한다.
<br>

하지만 `10.100.0.3:80`은 `netfilter`가 처리하는 규칙이 아니다. netfilter가 처리하는 규칙은 `10.3.241.152:80`이다.

## NodePort Service

쿠버네티스에서 서비스를 생성할 때 타입을 지정해주지 않는다면 `ClusterIP`로 설정된다. 서비스를 외부로 노출시기키 위해서 서비스의 타입을 `NodePort`로 지정한다. 이 타입은 `10.3.241.152`인 Cluster IP뿐만 아니라 노드의 IP 주소를 통해서도 특정 파드에 접근할 수 있도록 해준다.

<img src="https://user-images.githubusercontent.com/44857109/103462218-0f624200-4d67-11eb-8033-9ee262597f0d.png" width="80%" height="80%">

쿠버네티스가 `NodePort`타입으로 서비스를 생성할 때 `kube-proxy`는 노드의 인터페이스(eth0)에 대해서 `30000 ~ 32767`범위의 포트를 열고 요청을 받아들인다. kube-proxy는 이 포트로 오는 요청을 Cluster IP로 포워딩해주어서 결과적으로 노드의 주소를 이용해서 파드로 요청을 전달할 수 있게 된다.

## LoadBalancer Service

`NodePort`타입의 서비스는 외부 요청에 대한 로드밸런서와 내부 요청에 대한 로드밸런서가 따로 관리된다. `LoadBalancer`타입은 외부 IP를 할당해서 외부, 내부 요청을 한곳에서 처리할 수 있도록 하는 것 같다. 이부분은 읽어도 단어가 어려워서 뭔소리를 하는지 모르겠다.